include "cowgol.coh";
include "file.coh";
include "argv.coh";
include "strings.coh";

typedef string is [uint8];

var inputFilename: string;
var outputFilename: string;

var inputFile: FCB;
var inputFileLen: uint32;
var inputFilePos: uint32;
var outputFile: FCB;

var address: uint16;

var insnBuffer: uint8[6];
var insnLen: uint8 := 0;

var outputBuffer: uint8[20];
var outputLen: uint8 := 0;

const PARAM_TEXT := 1;
const PARAM_BYTE := 2;
const PARAM_WORD := 3;
const PARAM_XIX := 4;
const PARAM_XIY := 5;
const PARAM_XSP := 6;

record Parameter is
	value @at(0): uint16;
	text @at(0): string;
	type: uint8;
end record;

var parameters: Parameter[3];

var rolOps: string[] := { "rlc", "rrc", "rl", "rr", "sla", "sra", "sll", "srl" };
var aluOps: string[] := { "add", "adc", "sub", "sbc", "and", "xor", "or", "cp" };
var rRegisters: string[] := { "b", "c", "d", "e", "h", "l", "a", "?7" };
var qRegisters: string[] := { "bc", "de", "hl", "?3", "ix", "iy", "sp", "?7" };
var ccCodes: string[] := { "f", "lt", "le", "ule", "pe", "m", "z", "c",
	"?8", "ge", "gt", "ugt", "po", "p", "nz", "nc" };
	
var baseTemplates: string[256] := {
	# 00
	"nop",
	"halt",
	"di",
	"ei",
	"?",
	"?",
	"?",
	"D0incx (0)",

	# 08
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 10
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 18
	"",
	"",
	"W0jp 0",
	"",
	"",
	"",
	"",
	"",

	# 20
	"R0ld a, 0",
	"R0ld a, 0",
	"R0ld a, 0",
	"R0ld a, 0",
	"R0ld a, 0",
	"R0ld a, 0",
	"R0ld a, 0",
	"D0ld a, (0)",

	# 28
	"R0ld 0, a",
	"R0ld 0, a",
	"R0ld 0, a",
	"R0ld 0, a",
	"R0ld 0, a",
	"R0ld 0, a",
	"R0ld 0, a",
	"D0ld (0), a",

	# 30
	"R0B1ld 0, 1",
	"R0B1ld 0, 1",
	"R0B1ld 0, 1",
	"R0B1ld 0, 1",
	"R0B1ld 0, 1",
	"R0B1ld 0, 1",
	"R0B1ld 0, 1",
	"D0B1ld (0), 1",

	# 38
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 40
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 48
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 50
	"Q0push 0",
	"Q0push 0",
	"Q0push 0",
	"",
	"Q0push 0",
	"Q0push 0",
	"Q0push 0",
	"",

	# 58
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 60
	"L0D10 a, (1)",
	"L0D10 a, (1)",
	"L0D10 a, (1)",
	"L0D10 a, (1)",
	"L0D10 a, (1)",
	"L0D10 a, (1)",
	"L0D10 a, (1)",
	"L0D10 a, (1)",

	# 68
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 70
	"L0D10 hl, (1)",
	"L0D10 hl, (1)",
	"L0D10 hl, (1)",
	"L0D10 hl, (1)",
	"L0D10 hl, (1)",
	"L0D10 hl, (1)",
	"L0D10 hl, (1)",
	"L0D10 hl, (1)",

	# 78
	"L0W10 hl, 1",
	"L0W10 hl, 1",
	"L0W10 hl, 1",
	"L0W10 hl, 1",
	"L0W10 hl, 1",
	"L0W10 hl, 1",
	"L0W10 hl, 1",
	"L0W10 hl, 1",

	# 80
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 88
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 90
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 98
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# a0
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# a8
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# b0
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# b8
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# c0
	"C0J1jr 0, 1",
	"C0J1jr 0, 1",
	"C0J1jr 0, 1",
	"C0J1jr 0, 1",
	"C0J1jr 0, 1",
	"C0J1jr 0, 1",
	"C0J1jr 0, 1",
	"C0J1jr 0, 1",

	# c8
	"J0jr 0",
	"C0J1jr 0, 1",
	"C0J1jr 0, 1",
	"C0J1jr 0, 1",
	"C0J1jr 0, 1",
	"C0J1jr 0, 1",
	"C0J1jr 0, 1",
	"C0J1jr 0, 1",

	# d0
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# d8
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# e0
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# e8
	"Q0T4",
	"Q0T4",
	"Q0T4",
	"W0T4",
	"Q0T4",
	"Q0T4",
	"Q0T4",
	"D0T4",

	# f0
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# f8
	"A0T2",
	"A0T2",
	"A0T2",
	"A0T2",
	"A0T2",
	"A0T2",
	"A0T2",
	"swi",
};

var bank2Templates: string[256] := {
	# 00
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 08
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 10
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 18
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 20
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 28
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 30
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 38
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 40
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 48
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 50
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 58
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 60
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 68
	">0L2B12 0, 1",
	">0L2B12 0, 1",
	">0L2B12 0, 1",
	">0L2B12 0, 1",
	">0L2B12 0, 1",
	">0L2B12 0, 1",
	">0L2B12 0, 1",
	">0L2B12 0, 1",

	# 70
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 78
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 80
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 88
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 90
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 98
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# a0
	">0S11 0",
	">0S11 0",
	">0S11 0",
	">0S11 0",
	">0S11 0",
	">0S11 0",
	">0S11 0",
	">0S11 0",

	# a8
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# b0
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# b8
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# c0
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# c8
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# d0
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# d8
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# e0
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# e8
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# f0
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# f8
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",
};

var bank3Templates: string[256] := {
	# 00
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 08
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 10
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 18
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 20
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 28
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 30
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 38
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 40
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 48
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 50
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 58
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 60
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 68
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 70
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 78
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 80
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 88
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 90
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 98
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# a0
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# a8
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# b0
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# b8
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# c0
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# c8
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# d0
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# d8
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# e0
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# e8
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# f0
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# f8
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",
};

var bank4Templates: string[256] := {
	# 00
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 08
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 10
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 18
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 20
	"R1ld (0), 1",
	"R1ld (0), 1",
	"R1ld (0), 1",
	"R1ld (0), 1",
	"R1ld (0), 1",
	"R1ld (0), 1",
	"R1ld (0), 1",
	"R1ld (0), 1",

	# 28
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 30
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 38
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 40
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 48
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 50
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 58
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 60
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 68
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 70
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 78
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 80
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 88
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 90
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# 98
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# a0
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# a8
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# b0
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# b8
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# c0
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# c8
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# d0
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# d8
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# e0
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# e8
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# f0
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",

	# f8
	"",
	"",
	"",
	"",
	"",
	"",
	"",
	"",
};

sub StartError() is
	print("error: ");
end sub;

sub EndError() is
	print_nl();
	ExitWithError();
end sub;

sub SimpleError(s: string) is
	StartError();
	print(s);
	EndError();
end sub;

sub ToUpper(cin: uint8): (cout: uint8) is
	if (cin >= 'a') and (cin <= 'z') then
		cout := cin - ('a' - 'A');
	else
		cout := cin;
	end if;
end sub;

sub ReadByte(): (b: uint8) is
	b := FCBGetChar(&inputFile);
	insnBuffer[insnLen] := b;
	insnLen := insnLen + 1;
	inputFilePos := inputFilePos + 1;
end sub;

sub ReadWord(): (w: uint16) is
	w := ReadByte() as uint16;
	w := w | (ReadByte() as uint16 << 8);
end sub;

sub PrintByte(b: uint8) is
	outputBuffer[outputLen] := b;
	outputLen := outputLen + 1;
end sub;

sub Print(s: string) is
	loop
		var b := [s];
		s := @next s;
		if b == 0 then
			return;
		end if;
		PrintByte(b);
	end loop;
end sub;

sub PrintHexByte(value: uint8) is
    var i: uint8 := 2;
    loop
        var digit := value >> 4;
        if digit < 10 then
            digit := digit + '0';
        else
            digit := digit + ('a' - 10);
        end if;
        PrintByte(digit);
        value := value << 4;
        i := i - 1;
        if i == 0 then
            break;
        end if;
    end loop;
end sub;

sub PrintHexWord(value: uint16) is
    PrintHexByte((value >> 8) as uint8);
    PrintHexByte(value as uint8);
end sub;

sub PrintParameter(param: [Parameter]) is
	case param.type is
		when PARAM_TEXT:
			Print(param.text);

		when PARAM_WORD:
			PrintHexWord(param.value);

		when PARAM_BYTE:
			PrintHexByte(param.value as uint8);
	end case;
end sub;

sub ExecuteTemplate(template: string) is
	loop
		var b := [template];
		template := @next template;
		if b == 0 then
			return;
		end if;

		var paramIndex := (b - '0');
		if ((b >= 'a') and (b <= 'z')) or (b == ' ') or (b == ',') or (b == '(') or (b == ')') then
			PrintByte(b);
		elseif paramIndex < @sizeof parameters then
			PrintParameter(&parameters[paramIndex]);
		else
			paramIndex := [template] - '0';
			var param := &parameters[paramIndex];
			var current := insnBuffer[insnLen-1];
			template := @next template;
			case b is
				when 'B':
					param.type := PARAM_BYTE;
					param.value := ReadByte() as uint16;

				when 'W':
					param.type := PARAM_WORD;
					param.value := ReadWord() as uint16;

				when 'D':
					param.type := PARAM_WORD;
					param.value := (ReadByte() as uint16) | 0xff00;

				when 'Q':
					param.type := PARAM_TEXT;
					param.text := qRegisters[current & 7];

				when 'R':
					param.type := PARAM_TEXT;
					param.text := rRegisters[current & 7];

				when 'L':
					param.type := PARAM_TEXT;
					param.text := aluOps[current & 7];

				when 'S':
					param.type := PARAM_TEXT;
					param.text := rolOps[current & 7];

				when 'A':
					param.type := PARAM_BYTE;
					param.value := (current & 7) as uint16;

				when 'C':
					param.type := PARAM_TEXT;
					param.text := ccCodes[current & 15];

				when 'J':
					param.type := PARAM_WORD;
					param.value := address + (ReadByte() as int8 as uint16);

				when 'P':
					param.type := PARAM_WORD;
					param.value := address + ReadWord();

				when '>':
					param.type := PARAM_TEXT;
					param.text := rRegisters[param.value as uint8];

				when '<':
					param.type := PARAM_TEXT;
					param.text := qRegisters[param.value as uint8];

				when 'T':
					b := ReadByte();
					case paramIndex is
						when 2: template := bank2Templates[b];
						when 3: template := bank3Templates[b];
						when 4: template := bank4Templates[b];
						when else:
							SimpleError("unimplemented template");
					end case;
					if [template] == 0 then
						StartError();
						print("unimplemented template for byte ");
						print_hex_i8(b);
						print(" bank ");
						print_hex_i8(paramIndex as uint8);
						EndError();
					end if;

				when else:
					StartError();
					print("bad template char ");
					print_char(b);
					EndError();
			end case;
		end if;
	end loop;
end sub;

sub ReadInstruction() is
	insnLen := 0;
	outputLen := 0;

	var b := ReadByte();
	var template := baseTemplates[b];
	if [template] == 0 then
		StartError();
		print("unimplemented template for byte ");
		print_hex_i8(b);
		EndError();
	end if;
	ExecuteTemplate(template);
end sub;

sub ParseArguments() is
	sub SyntaxError() is
		StartError();
		print("syntax: cowdis <inputfilename> [-o <outputfilename>] [-g <address>\n");
		EndError();
	end sub;

	ArgvInit();
	loop
		var s := ArgvNext();
		if s == (0 as string) then
			break;
		end if;

		if [s] == '-' then
			case ToUpper([s+1]) is
				when 'O':
					outputFilename := ArgvNext();

				when 'G':
					var result: int32;
					var ptr: [uint8];
					(result, ptr) := AToI(ArgvNext());
					if [ptr] != 0 then
						SyntaxError();
					end if;
					address := result as uint16;

				when else:
					SyntaxError();
			end case;
		else
			if inputFilename != (0 as string) then
				SyntaxError();
			end if;
			inputFilename := s;
		end if;
	end loop;

	if inputFilename == (0 as string) then
		SyntaxError();
	end if;

	sub CheckFCBOpen(e: uint8, s: string) is
		if e != 0 then
			StartError();
			print("cannot open ");
			print(s);
			EndError();
		end if;
	end sub;

	CheckFCBOpen(FCBOpenIn(&inputFile, inputFilename), inputFilename);
	inputFileLen := FCBExt(&inputFile);
	inputFilePos := 0;
	if outputFilename != (0 as string) then
		CheckFCBOpen(FCBOpenOut(&outputFile, outputFilename), outputFilename);
	end if;
end sub;

sub Main() is
	while inputFilePos < inputFileLen loop
		ReadInstruction();

		print_hex_i16(address);
		print(" ");
		var i: uint8 := 0;
		while i != insnLen loop
			print_hex_i8(insnBuffer[i]);
			print(" ");
			i := i + 1;
		end loop;

		print(": ");
		outputBuffer[outputLen] := 0;
		print(&outputBuffer[0]);
		print_nl();

		address := address + (insnLen as uint16);
	end loop;
end sub;

ParseArguments();
Main();

